# zf-state-machine

Этот модуль позволяет организовать в вашем приложении 
стейт-машины ([недетерминированные конечные автоматы - НКА](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BD%D0%B5%D1%87%D0%BD%D1%8B%D0%B9_%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82#%D0%94%D0%B5%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
), которые позволят выполнять дополнительные действия при переходе объектов 
из одного состояния в другое или сразу после перехода.

Особенностями данного НКА является:
-----------------------------------
1. использование [Doctrine2](http://doctrine2.readthedocs.io/en/stable/tutorials/getting-started.html) для описания списка состояний, действий и переходов
1. Использование стандартных валидаторов ZF для проверки возможности действий
1. Использование [функциональных объектов](https://ru.wikipedia.org/wiki/%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82) 
(функторов) для выполнения дополнительных действий при выполнении действия над объектом
 или после него.
1. защита от зацикливания при каскадном вызове НКА

## Оглавление
1. Область применения
1. Принцип работы
1. Пример реализации и использования:
    1. Создаем классы таблиц
    1. Описываем конфигурацию.
    1. Создаем валидаторы и функторы
    1. Используем
1. Внутренняя организация
    1. Основные методы
    1. Матрица переходов
    1. Валидаторы действия
    1. Функторы
    1. Транзакции, flush() и etc
    1. Каскадные вызовы и защита от зацикливания

## Область применения
В приложениях часто необходимо ограничить доступ к тем или иным действиям
над объектом. Управление правами на действие успешно реализуется с
помощью RBAC-модулей. Однако RBAC-модуль контролирует право на действие 
пользователя в зависимости от роли, но не контролирует возможность совершения
действия в зависимости от состояния объекта. 
Пример: ведение пропусков. Вася может редактировать пропуск, но до тех пор, пока
пропуск не выдан.
Данная зачача успешно решается при помощи конечного автомата (finite-state machine).

## Принцип работы:

Объект - это доктриновская "сущность"(entity), которая имеет 
свойство, хранящее состояние объекта (обычно это связь много к одному к словарю
состояний).

Словарь действий - это доктриновская "сущность" - словарь возможных действий
над нашим объектом.

Матрица переходов - это две сущности A и B, связанные между собой отношением
один ко многим.
   
Для объекта, который имеет словарь состояний, описывается словарь действий 
и матрица переходов из состояния в состояние при выполнении действия. Т.к. у нас
недетерминированный конечный автомат (НКА), то выполнение действия может приводить объект
из исходного состояние в одно из нескольких других состояний согласно
матрице переходов, в том числе оставлять в исходном.

В метод НКА doAction подается объект, действие, которое хотим совершить над
объектом и дополнительные данные.  
1. НКА проверяет возможность совершения действия:
    1. наличие действия для объекта
    1. возможность выполнения действия над объектом в текущем состоянии согласно матрицы
     переходов
    1. дополнительные проверки,например в частности права на действие
1. при успешной проверке
    1. определяется новое состояние, в которое будет переведен объект
    1. выполняются, если определены, действия перед переходом в новое состояние
    1. объект переводится в новое состояние
    1. выполняются, если определены, действия после перехода объекта в новое состояние.
